<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ocr.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ocr.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const crypto = require('crypto');
const Promise = require('bluebird');
const fs = require('fs');
const path = require('path');
const net = require('net');

Promise.promisifyAll(fs);

/**
 * 123 -> 000123
 * @function
 * @param {Integer} num The number needed to append padding
 * @param {Integer} size The padding count
 * @return {String} after padding
 */
function pad(num, size) {
  var s = num + "";
  while (s.length &lt; size) s = "0" + s;
  return s;
}

/**
 * Socket API wrapper for TIMS OCR server
 * @class OCRSocket
 */
function OCRSocket(ip, port) {
  this.ip = ip;
  this.port = port;
}

module.exports.create = function(ip, port) {
  return new OCRSocket(ip, port);
};

OCRSocket.fn = OCRSocket.prototype;

OCRSocket.fn.scan = function scan(filePath) {
  var self = this;
  return new Promise(function (resolve, reject) {
    var body = {
      fileId: 'img123',
      mod: 0, // 0->sync, 1->async
      IP: '127.0.0.1',
      port: '8088'
    };
    var bodyStr = JSON.stringify(body);

    var imgBuf = fs.readFileSync(filePath);

    var socketLength = 15 + 7 + bodyStr.length + imgBuf.length;
    var socketLengthStr = socketLength - 15 + "";
    var socketLengthStr = pad(socketLengthStr, 15);

    var jsonlength = bodyStr.length;
    var jsonlength = pad(jsonlength, 7);

    const options = {
      port: self.port,
      host: self.ip
    };
    const socket = net.connect(options, () => {
      console.log('Connected');
      socket.write(socketLengthStr); // request head
      socket.write(jsonlength); // json head
      socket.write(bodyStr); // json body
      socket.write(imgBuf); // image file stream
    });
    socket.on('close', () => {
      resolve({
        success: true
      });
    });
    socket.on('connect', () => {
    });
    socket.on('data', (/*Buffer*/data) => {
      console.log('on data event');
      console.log(typeof data);
      console.log(data);
      console.log('Received: ' + data);
      socket.destroy(); // kill client after server's response
    });
    socket.on('error', () => {
      console.log('on error event');
    });
  });
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OCR.html">OCR</a></li><li><a href="OCRSocket.html">OCRSocket</a></li></ul><h3>Global</h3><ul><li><a href="global.html#download">download</a></li><li><a href="global.html#getImg">getImg</a></li><li><a href="global.html#pad">pad</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sat Aug 06 2016 17:24:26 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
